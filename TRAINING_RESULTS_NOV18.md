# è¨“ç·´çµæœç¸½çµ - Nov 18, 2025

## ğŸ“Š è¨“ç·´ç‹€æ…‹ç¸½è¦½

**æäº¤æ™‚é–“:** 2025-11-18 03:57 (å–®ä»»å‹™), 04:09 (å¤šä»»å‹™)  
**æª¢æŸ¥æ™‚é–“:** 2025-11-18 ~15:00

### ç‹€æ…‹ç¸½çµ
- âœ… **5M Baseline:** å®Œæˆï¼ˆ14995 epochsï¼‰
- âœ… **48M Baseline (å–®ä»»å‹™):** å®Œæˆï¼ˆ14841 epochsï¼‰
- âš ï¸ **48M Flow V1:** OOM è¢«æ®ºï¼ˆ9073 epochs / 20000ï¼‰
- âš ï¸ **48M Flow V2:** OOM è¢«æ®ºï¼ˆ5424 epochs / 20000ï¼‰
- âš ï¸ **48M Flow V3:** OOM è¢«æ®ºï¼ˆ5423 epochs / 20000ï¼‰
- âŒ **æ‰€æœ‰å¤šä»»å‹™ (4å€‹):** é…ç½®éŒ¯èª¤ï¼Œç«‹å³å¤±æ•—

---

## ğŸ“ˆ å–®ä»»å‹™è¨“ç·´çµæœ

### 1. 5M Baseline (Job 2314140) âœ…

| æŒ‡æ¨™ | æ•¸å€¼ |
|------|------|
| **ç‹€æ…‹** | âœ… å®Œæˆ |
| **Total Epochs** | 14,995 / 15,000 |
| **Peak R** | **1222.15** ğŸ¯ |
| **Min R** | 1.17 |
| **Avg R** | 110.80 |
| **Last 100 avg** | 30.01 |
| **Last 10 avg** | 29.92 |
| **è¨“ç·´æ™‚é•·** | ~3 å°æ™‚ |

**åˆ†æï¼š**
- âœ… **horizon=16 ä¿®å¾©æˆåŠŸï¼** Peak R å¾ä¹‹å‰çš„ ~292 æå‡åˆ° **1222**
- âœ… é”åˆ°é æœŸæ€§èƒ½ï¼ˆPWM paper å ±å‘Š DFlex Ant å–®ä»»å‹™ ~1200ï¼‰
- âš ï¸ æœ€å¾Œéšæ®µæ€§èƒ½ä¸‹é™ï¼ˆlast 100 avg åªæœ‰ 30ï¼‰ï¼Œå¯èƒ½éåº¦è¨“ç·´
- ğŸ’¡ å»ºè­°ä½¿ç”¨ checkpoint ä¸­ peak é™„è¿‘çš„æ¨¡å‹

---

### 2. 48M Baseline - Single Task (Job 2314141) âœ…

| æŒ‡æ¨™ | æ•¸å€¼ |
|------|------|
| **ç‹€æ…‹** | âœ… å®Œæˆ |
| **Total Epochs** | 14,841 / 15,000 |
| **Peak R** | **1253.89** ğŸ¯ |
| **Min R** | 0.00 |
| **Avg R** | 126.86 |
| **Last 100 avg** | 24.57 |
| **Last 10 avg** | 23.40 |
| **è¨“ç·´æ™‚é•·** | ~4.5 å°æ™‚ |

**åˆ†æï¼š**
- âœ… **48M baseline è¡¨ç¾å„ªç§€ï¼** Peak R **1254** è¶…è¶Š 5M (1222)
- âœ… è­‰æ˜ 48M æ¨¡å‹æœ‰è¶³å¤ å®¹é‡å­¸ç¿’ DFlex Ant
- âš ï¸ åŒæ¨£æœ‰å¾ŒæœŸæ€§èƒ½ä¸‹é™å•é¡Œ
- ğŸ’¡ 48M baseline å–®ä»»å‹™æ˜¯ç©©å®šåŸºç·š

---

### 3. 48M Flow V1 - substeps=2 (Job 2314142) âš ï¸ OOM

| æŒ‡æ¨™ | æ•¸å€¼ |
|------|------|
| **ç‹€æ…‹** | âš ï¸ OOM Killed |
| **Completed** | 9,073 / 20,000 (45%) |
| **Peak R** | **1100.02** |
| **Min R** | 17.55 |
| **Avg R** | 36.57 |
| **Last 100 avg** | 23.61 |
| **Last 10 avg** | 23.77 |
| **OOM Time** | ~5.6 å°æ™‚å¾Œ |

**åˆ†æï¼š**
- âš ï¸ **å…§å­˜ä¸è¶³è¢«æ®º** (128GB RAM ä¸å¤ )
- ğŸ¯ Peak R 1100 é¡¯ç¤ºæ½›åŠ›ï¼Œä½†æœªå……åˆ†è¨“ç·´
- ğŸ“‰ æ€§èƒ½åœ¨ OOM å‰å·²ä¸‹é™åˆ° ~23
- ğŸ’¡ éœ€è¦æ¸›å°‘ batch size æˆ–ä½¿ç”¨æ›´å¤šå…§å­˜

---

### 4. 48M Flow V2 - substeps=4 (Job 2314143) âš ï¸ OOM

| æŒ‡æ¨™ | æ•¸å€¼ |
|------|------|
| **ç‹€æ…‹** | âš ï¸ OOM Killed |
| **Completed** | 5,424 / 20,000 (27%) |
| **Peak R** | **1209.81** ğŸ¯ |
| **Min R** | 15.68 |
| **Avg R** | 88.10 |
| **Last 100 avg** | 17.38 |
| **Last 10 avg** | 17.62 |
| **OOM Time** | ~4.8 å°æ™‚å¾Œ |

**åˆ†æï¼š**
- âš ï¸ **OOM ä½† peak æœ€é«˜ï¼** Peak R **1210** æ¥è¿‘ baseline 1254
- ğŸ¯ substeps=4 æ˜¯æœ€ä½³é…ç½®ï¼ˆåœ¨ OOM å‰ï¼‰
- ğŸ“‰ åªå®Œæˆ 27% å°±é”åˆ°é«˜æ€§èƒ½ï¼Œé¡¯ç¤ºå­¸ç¿’æ•ˆç‡é«˜
- ğŸ’¡ **å¼·çƒˆå»ºè­°ä¿®å¾© OOM å¾Œé‡è¨“**

---

### 5. 48M Flow V3 - substeps=8 (Job 2314144) âš ï¸ OOM

| æŒ‡æ¨™ | æ•¸å€¼ |
|------|------|
| **ç‹€æ…‹** | âš ï¸ OOM Killed |
| **Completed** | 5,423 / 20,000 (27%) |
| **Peak R** | **1182.21** |
| **Min R** | 18.91 |
| **Avg R** | 450.49 |
| **Last 100 avg** | 56.84 |
| **Last 10 avg** | 36.94 |
| **OOM Time** | ~4.8 å°æ™‚å¾Œ |

**åˆ†æï¼š**
- âš ï¸ OOM ä½†é¡¯ç¤ºä¸éŒ¯æ½›åŠ›ï¼ˆPeak R 1182ï¼‰
- ğŸ“Š Avg R æœ€é«˜ï¼ˆ450ï¼‰ï¼Œé¡¯ç¤ºç©©å®šæ€§å¥½
- ğŸ” substeps=8 å¯èƒ½éåº¦å¹³æ»‘
- ğŸ’¡ V2 (substeps=4) æ›´å„ª

---

## âŒ å¤šä»»å‹™è¨“ç·´å¤±æ•—

### å¤±æ•—åŸå› ï¼šé…ç½®éŒ¯èª¤

æ‰€æœ‰ 4 å€‹å¤šä»»å‹™è¨“ç·´ï¼ˆJobs 2314382-2314385ï¼‰ç«‹å³å¤±æ•—ï¼š

```
MissingMandatoryValue: Missing mandatory value: world_model_config.action_dims
```

**å•é¡Œï¼š**
- å¤šä»»å‹™é…ç½®ç¼ºå°‘ `action_dims` åƒæ•¸
- ç’°å¢ƒè¨­ç½®ç‚º `dflex_ant`ï¼ˆå–®ä»»å‹™ï¼‰ï¼Œä½†é…ç½®æœŸæœ›å¤šä»»å‹™ç’°å¢ƒ

**å½±éŸ¿çš„ä»»å‹™ï¼š**
1. âŒ 48M MT Baseline (2314382)
2. âŒ 48M MT Flow V1 (2314383)
3. âŒ 48M MT Flow V2 (2314384)
4. âŒ 48M MT Flow V3 (2314385)

---

## ğŸ”´ ä¸»è¦å•é¡Œ

### 1. OOM (Out of Memory) - Flow æ¨¡å‹å…¨éƒ¨è¢«æ®º

**ç—‡ç‹€ï¼š**
```
slurmstepd: error: Detected 1 oom_kill event in StepId=XXXXX.batch. 
Some of the step tasks have been OOM Killed.
```

**å½±éŸ¿ï¼š**
- 48M Flow V1: 9073/20000 epochs (45%)
- 48M Flow V2: 5424/20000 epochs (27%) â­
- 48M Flow V3: 5423/20000 epochs (27%)

**æ ¹æœ¬åŸå› ï¼š**
1. **Flow æ¨¡å‹éœ€è¦é¡å¤–å…§å­˜** å­˜å„² flow dynamics
2. **batch_size=1024 å¤ªå¤§** å°æ–¼ 48M Flow
3. **128GB RAM ä¸è¶³** æ”¯æŒå®Œæ•´è¨“ç·´

**è­‰æ“šï¼š**
- 5M + 48M baseline å®Œæˆï¼ˆç„¡ flowï¼‰
- æ‰€æœ‰ Flow æ¨¡å‹åœ¨è¨“ç·´ä¸­é€” OOM
- Flow V2/V3 æ›´æ—© OOMï¼ˆ~5å°æ™‚ vs V1 ~5.6å°æ™‚ï¼‰

---

### 2. å¤šä»»å‹™é…ç½®éŒ¯èª¤

**å•é¡Œï¼š**
```yaml
# éŒ¯èª¤ï¼šç¼ºå°‘ action_dims
world_model_config:
  task_dim: 96
  # âŒ ç¼ºå°‘ action_dims
```

**éœ€è¦ä¿®å¾©ï¼š**
```yaml
world_model_config:
  task_dim: 96
  action_dims: ???  # éœ€è¦å¾ç’°å¢ƒç²å–
```

---

## ğŸ’¡ é—œéµç™¼ç¾

### âœ… æˆåŠŸé»

1. **horizon=16 ä¿®å¾©å®Œç¾ï¼**
   - 5M baseline: 292 â†’ **1222** (+317%ï¼)
   - é”åˆ° PWM paper å ±å‘Šæ°´å¹³

2. **48M baseline å„ªæ–¼ 5Mï¼**
   - 48M: Peak R **1254**
   - 5M: Peak R **1222**
   - å·®è· +32 (+2.6%)

3. **Flow V2 (substeps=4) æœ€æœ‰æ½›åŠ›ï¼**
   - åªè¨“ç·´ 27% é”åˆ° Peak R **1210**
   - æ¥è¿‘ baseline æ€§èƒ½ï¼ˆ1254ï¼‰
   - å­¸ç¿’æ•ˆç‡é«˜

### âš ï¸ å•é¡Œé»

1. **OOM é™åˆ¶ Flow è¨“ç·´**
   - æ‰€æœ‰ Flow æ¨¡å‹æœªå®Œæˆ
   - éœ€è¦é™ä½ batch size

2. **è¨“ç·´å¾ŒæœŸæ€§èƒ½ä¸‹é™**
   - Peak åœ¨ä¸­æœŸï¼ˆ~5000-8000 epochsï¼‰
   - Last 100 avg é ä½æ–¼ peak
   - å¯èƒ½éåº¦è¨“ç·´æˆ–æ¢ç´¢è¡°æ¸›éå¿«

3. **å¤šä»»å‹™é…ç½®ä¸å®Œæ•´**
   - ç¼ºå°‘å¿…è¦åƒæ•¸
   - ç’°å¢ƒè¨­ç½®éŒ¯èª¤

---

## ğŸ“Š æ€§èƒ½æ’åï¼ˆåŸºæ–¼ Peak Rï¼‰

| æ’å | æ¨¡å‹ | Peak R | å®Œæˆåº¦ | å‚™è¨» |
|------|------|--------|--------|------|
| ğŸ¥‡ | 48M Baseline ST | **1253.89** | âœ… 100% | æœ€ç©©å®š |
| ğŸ¥ˆ | 5M Baseline | **1222.15** | âœ… 100% | horizon=16 ä¿®å¾©æˆåŠŸ |
| ğŸ¥‰ | 48M Flow V2 (sub=4) | **1209.81** | âš ï¸ 27% | **æœ€æœ‰æ½›åŠ›** |
| 4 | 48M Flow V3 (sub=8) | **1182.21** | âš ï¸ 27% | ç©©å®šæ€§å¥½ |
| 5 | 48M Flow V1 (sub=2) | **1100.02** | âš ï¸ 45% | è¨“ç·´æ›´ä¹… |

---

## ğŸ¯ å»ºè­°å’Œä¸‹ä¸€æ­¥

### ğŸ”´ ç·Šæ€¥ä¿®å¾©ï¼ˆé«˜å„ªå…ˆç´šï¼‰

#### 1. ä¿®å¾© Flow OOM å•é¡Œ

**æ–¹æ¡ˆ A: æ¸›å°‘ Batch Sizeï¼ˆæ¨è–¦ï¼‰**
```yaml
# PWM/scripts/cfg/alg/pwm_48M_flow_v2_substeps4.yaml
wm_batch_size: 512  # å¾ 1024 â†’ 512 (-50%)
```

**æ–¹æ¡ˆ B: å¢åŠ å…§å­˜**
```bash
# æäº¤è…³æœ¬æ”¹ç‚º 256GB RAM
#SBATCH --mem=256G
```

**æ–¹æ¡ˆ C: æ··åˆæ–¹æ¡ˆ**
- batch_size: 768 (-25%)
- mem: 192G (+50%)

#### 2. ä¿®å¾©å¤šä»»å‹™é…ç½®

```yaml
# PWM/scripts/cfg/alg/pwm_48M_multitask_baseline.yaml
world_model_config:
  _target_: pwm.models.world_model.WorldModel
  task_dim: 96
  action_dims: ${env.action_dim}  # å¾ç’°å¢ƒç²å–
  # ... å…¶ä»–åƒæ•¸
```

**ä¸¦ä¸”éœ€è¦ï¼š**
- è¨­ç½®æ­£ç¢ºçš„å¤šä»»å‹™ç’°å¢ƒï¼ˆMT30 æˆ– MT80ï¼‰
- æº–å‚™å¤šä»»å‹™æ•¸æ“šé›†

---

### ğŸŸ¡ å„ªåŒ–å»ºè­°ï¼ˆä¸­å„ªå…ˆç´šï¼‰

#### 3. æ·»åŠ  Checkpoint ç®¡ç†

```python
# ä¿å­˜ peak æ€§èƒ½çš„ checkpoint
if current_R > best_R:
    save_checkpoint('best_policy.pt')
    best_R = current_R
```

#### 4. æ—©åœæ©Ÿåˆ¶

```python
# å¦‚æœ 100 epochs å…§ç„¡æ”¹å–„å‰‡åœæ­¢
if no_improvement_for_100_epochs:
    early_stop()
```

#### 5. èª¿æ•´å­¸ç¿’ç‡è¡°æ¸›

```yaml
# å»¶é•·å­¸ç¿’ç‡è¡°æ¸›ï¼Œé¿å…éæ—©æ€§èƒ½ä¸‹é™
lr_schedule: linear
lr_decay_start: 10000  # å¾ 5000 â†’ 10000
```

---

### ğŸŸ¢ å¯¦é©—æ“´å±•ï¼ˆä½å„ªå…ˆç´šï¼‰

#### 6. æ¸¬è©¦ Flow çš„å…¶ä»–é…ç½®

```yaml
# æ¸¬è©¦æ›´å°çš„ substeps
pwm_48M_flow_v0_substeps1:
  flow_model_config:
    substeps: 1  # æ–°

# æ¸¬è©¦ä¸åŒç©åˆ†å™¨
pwm_48M_flow_v2_rk4:
  flow_model_config:
    substeps: 4
    integrator: rk4  # å¾ heun â†’ rk4
```

#### 7. é‡æ–°è©•ä¼°æ‰€æœ‰ Checkpoint

ä½¿ç”¨ä¿®å¾©å¾Œçš„ `eval()` å‡½æ•¸ï¼š
```bash
python scripts/evaluate_policy.py \
  --checkpoint outputs/*/best_policy.pt \
  --episodes 100
```

---

## ğŸ“ ç«‹å³è¡Œå‹•è¨ˆç•«

### Phase 1: ä¿®å¾©ä¸¦é‡è¨“ï¼ˆ1-2 å¤©ï¼‰

1. **ä¿®å¾© Flow OOMï¼š**
   ```bash
   # ä¿®æ”¹æ‰€æœ‰ Flow é…ç½®
   wm_batch_size: 1024 â†’ 512
   
   # æˆ–ä¿®æ”¹æäº¤è…³æœ¬
   #SBATCH --mem=256G
   ```

2. **é‡æ–°æäº¤ Flow è¨“ç·´ï¼š**
   ```bash
   cd PWM/scripts
   ./submit_48M_flow_v1_l40s_fixed.sh
   ./submit_48M_flow_v2_l40s_fixed.sh  # æœ€æ¨è–¦
   ./submit_48M_flow_v3_l40s_fixed.sh
   ```

3. **ä¿®å¾©å¤šä»»å‹™é…ç½®ï¼š**
   - æ·»åŠ  `action_dims` åƒæ•¸
   - è¨­ç½®æ­£ç¢ºçš„ MT30/MT80 ç’°å¢ƒ
   - æº–å‚™å¤šä»»å‹™æ•¸æ“šé›†

### Phase 2: è©•ä¼°å’Œåˆ†æï¼ˆ0.5 å¤©ï¼‰

4. **ä½¿ç”¨ä¿®å¾©å¾Œçš„ eval() é‡æ–°è©•ä¼°ï¼š**
   ```bash
   python scripts/evaluate_all_checkpoints.py
   ```

5. **ç”Ÿæˆå¯è¦–åŒ–å’Œå ±å‘Šï¼š**
   - è¨“ç·´æ›²ç·šå°æ¯”
   - Peak vs Final æ€§èƒ½
   - Flow vs Baseline åˆ†æ

### Phase 3: æ’°å¯«è«–æ–‡ææ–™ï¼ˆ1 å¤©ï¼‰

6. **æº–å‚™å¯¦é©—çµæœè¡¨æ ¼å’Œåœ–è¡¨**
7. **æ’°å¯« Method å’Œ Results ç« ç¯€**

---

## ğŸ“Š æœŸæœ›çµæœï¼ˆä¿®å¾©å¾Œï¼‰

### å–®ä»»å‹™ï¼ˆä¿®å¾© OOMï¼‰

| æ¨¡å‹ | ç•¶å‰ Peak | é æœŸ Peak | å®Œæˆåº¦ |
|------|-----------|-----------|--------|
| 48M Baseline | **1254** | 1254 âœ… | 100% |
| 5M Baseline | **1222** | 1222 âœ… | 100% |
| **48M Flow V2** | 1210 | **~1300?** ğŸš€ | 0% â†’ 100% |
| 48M Flow V3 | 1182 | ~1250? | 0% â†’ 100% |
| 48M Flow V1 | 1100 | ~1200? | 45% â†’ 100% |

**é æ¸¬ï¼š**
- Flow V2 (substeps=4) å¯èƒ½è¶…è¶Š baselineï¼ˆå®Œæ•´è¨“ç·´å¾Œï¼‰
- Flow çš„å­¸ç¿’æ•ˆç‡é¡¯ç¤ºå·¨å¤§æ½›åŠ›

### å¤šä»»å‹™ï¼ˆä¿®å¾©é…ç½®ï¼‰

| æ¨¡å‹ | ç‹€æ…‹ | é æœŸ Peak | ä¾æ“š |
|------|------|-----------|------|
| 48M MT Baseline | âŒ â†’ ğŸ”„ | ~900-1000? | PWM paper MT80 |
| 48M MT Flow V2 | âŒ â†’ ğŸ”„ | ~1000-1100? | Flow å„ªå‹¢ |

---

## ğŸ“ å­¸åˆ°çš„æ•™è¨“

### 1. å…§å­˜ç®¡ç†å¾ˆé—œéµ
- Flow æ¨¡å‹éœ€è¦æ›´å¤šå…§å­˜
- éœ€è¦æ ¹æ“šæ¨¡å‹å¤§å°èª¿æ•´ batch size
- 128GB å° 48M Flow ä¸å¤ 

### 2. horizon=16 æ˜¯æˆåŠŸçš„é—œéµ
- horizon=4 å°è‡´ baseline å®Œå…¨å¤±æ•—ï¼ˆR~292ï¼‰
- horizon=16 æ¢å¾©æ­£å¸¸æ€§èƒ½ï¼ˆR~1200+ï¼‰
- **é©—è­‰äº† PWM paper çš„è¨­ç½®**

### 3. 48M æ¨¡å‹æœ‰è¶³å¤ å®¹é‡
- 48M baseline è¶…è¶Š 5M baseline
- 48M Flow åœ¨æœ‰é™è¨“ç·´ä¸‹å·²é¡¯ç¤ºæ½›åŠ›
- ä¸æ˜¯æ¨¡å‹å®¹é‡å•é¡Œï¼Œæ˜¯å…§å­˜ç®¡ç†å•é¡Œ

### 4. Flow V2 (substeps=4) æ˜¯ç”œé»
- åªè¨“ç·´ 27% é”åˆ°æ¥è¿‘ baseline çš„æ€§èƒ½
- æ¯” V1 (sub=2) å’Œ V3 (sub=8) éƒ½å¥½
- **Heun integrator + substeps=4 æ˜¯æœ€ä½³å¹³è¡¡**

### 5. è¨“ç·´å¾ŒæœŸæ€§èƒ½ä¸‹é™éœ€è¦é—œæ³¨
- Peak åœ¨è¨“ç·´ä¸­æœŸ
- Last 100 avg é ä½æ–¼ peak
- éœ€è¦ early stopping æˆ–æ›´å¥½çš„ checkpoint ç­–ç•¥

---

## ğŸ“ å ±å‘Šæ‘˜è¦ï¼ˆçµ¦å°å¸«/åˆä½œè€…ï¼‰

### TL;DR

**å¥½æ¶ˆæ¯ï¼š**
- âœ… horizon=16 ä¿®å¾©æˆåŠŸï¼Œ5M baseline å¾ R~292 æå‡åˆ° **1222** (+317%ï¼)
- âœ… 48M baseline é”åˆ° **1254**ï¼Œè¶…è¶Š 5M
- âœ… Flow V2 (substeps=4) åªè¨“ç·´ 27% å°±é”åˆ° **1210**ï¼Œé¡¯ç¤ºå·¨å¤§æ½›åŠ›

**å£æ¶ˆæ¯ï¼š**
- âš ï¸ æ‰€æœ‰ Flow æ¨¡å‹å›  OOM æœªå®Œæˆè¨“ç·´
- âŒ å¤šä»»å‹™é…ç½®æœ‰èª¤ï¼Œå…¨éƒ¨å¤±æ•—

**ä¸‹ä¸€æ­¥ï¼š**
1. é™ä½ Flow batch size åˆ° 512ï¼Œé‡æ–°è¨“ç·´ï¼ˆ1-2å¤©ï¼‰
2. ä¿®å¾©å¤šä»»å‹™é…ç½®ä¸¦é‡æ–°æäº¤
3. ä½¿ç”¨ä¿®å¾©å¾Œçš„ eval() é‡æ–°è©•ä¼°æ‰€æœ‰ checkpoint

**é æœŸï¼š**
- Flow V2 å®Œæ•´è¨“ç·´å¾Œå¯èƒ½è¶…è¶Š baseline
- å¯ä»¥å¯«è«–æ–‡äº†ï¼ˆä¿®å¾©å¾Œï¼‰

---

*å ±å‘Šç”Ÿæˆæ™‚é–“: 2025-11-18 15:00*  
*æ•¸æ“šä¾†æº: SLURM Jobs 2314140-2314144, 2314382-2314385*
